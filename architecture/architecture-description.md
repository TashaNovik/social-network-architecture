Диаграмма представляет собой архитектуру микросервисов, разделённую на несколько доменов и уровней взаимодействия. Ниже описаны все микросервисы, их функции, используемые технологии и взаимодействие между ними.

## Общая структура

Диаграмма включает следующие основные компоненты:
- **Внешние сущности**: User (Пользователь), Administrator (Администратор), External Services (Внешние сервисы).
- **API Gateway**: Центральная точка входа для маршрутизации запросов.
- **Доменные микросервисы**, разделённые на 4 группы:
  - **Core & Media**: Основные сервисы и работа с медиа.
  - **Supporting Services**: Поддерживающие сервисы.
  - **Content & Feeds**: Сервисы для работы с контентом и лентами.
  - **User & Social Graph**: Сервисы для управления пользователями и социальной графой.
- **Общая инфраструктура (Shared Infrastructure)**: Redis Cluster и Apache Kafka для кэширования и асинхронного взаимодействия.

## Внешние сущности

- **User (Пользователь)**: 
  - Взаимодействует с системой через API Gateway по протоколу HTTPS.
  - Использует Users API для отправки запросов.
- **Administrator (Администратор)**: 
  - Взаимодействует через API Gateway по HTTPS.
  - Использует Admin API для управления системой.
- **External Services (Внешние сервисы)**: 
  - Включают Email и Push-уведомления.
  - Используются для доставки медиа (Delivers Media via).

## API Gateway

- **API Gateway [Kong/Nginx]**:
  - Центральная точка входа для всех внешних запросов.
  - Принимает запросы от пользователей и администраторов по HTTPS.
  - Маршрутизирует запросы к микросервисам по протоколу gRPC или REST.

## Доменные микросервисы

### 1. Core & Media (Основные сервисы и работа с медиа)

- **Notification Service [MongoDB]**:
  - Функция: Отправляет уведомления (Email, Push) через внешние сервисы.
  - Технологии: MongoDB для хранения данных, Redis Cluster для кэширования и подписки на уведомления (Pub/Sub).
  - Взаимодействие: Отправляет уведомления внешним сервисам.

- **Media Service [S3, PostgreSQL]**:
  - Функция: Управляет медиафайлами, доставляет их через CDN [CloudFront].
  - Технологии: S3 для хранения файлов, PostgreSQL для метаданных, Redis для подписки на уведомления (Pub/Sub).
  - Взаимодействие: Доставляет медиа внешним сервисам и социальным сетям.

- **Messaging Service [Cassandra, WebSocket]**:
  - Функция: Обеспечивает функционал мессенджера в реальном времени.
  - Технологии: Cassandra для хранения сообщений, WebSocket для обмена данными, Redis для подписки на уведомления (Pub/Sub).
  - Взаимодействие: Обрабатывает сообщения пользователей через WebSocket.

### 2. Supporting Services (Поддерживающие сервисы)

- **Search Service [Elasticsearch]**:
  - Функция: Обеспечивает поиск по данным системы.
  - Технологии: Elasticsearch для индексации и поиска, Apache Kafka для подписки на поисковые события (Sub: for Search).
  - Взаимодействие: Получает события поиска через Kafka.

- **Admin Service [PostgreSQL]**:
  - Функция: Управляет административными задачами.
  - Технологии: PostgreSQL для хранения данных.
  - Взаимодействие: Принимает запросы от API Gateway по gRPC/REST.

### 3. Content & Feeds (Контент и ленты)

- **Post Service [MongoDB]**:
  - Функция: Управляет постами пользователей.
  - Технологии: MongoDB для хранения данных, Apache Kafka для публикации событий контента (Pub: Content Events).
  - Взаимодействие: Принимает запросы через API Gateway (gRPC/REST), публикует события в Kafka.

- **Comment Service [MongoDB]**:
  - Функция: Управляет комментариями к постам.
  - Технологии: MongoDB для хранения данных, Apache Kafka для публикации событий контента (Pub: Content Events).
  - Взаимодействие: Принимает запросы через API Gateway (gRPC/REST), публикует события в Kafka.

- **Newsfeed Service [PostgreSQL]**:
  - Функция: Формирует новостные ленты пользователей.
  - Технологии: PostgreSQL для хранения данных, Apache Kafka для подписки на события лент (Sub: for Feeds) и публикации событий контента (Pub: Content Events).
  - Взаимодействие: Принимает запросы через API Gateway, взаимодействует с Kafka.

### 4. User & Social Graph (Пользователи и социальный граф)

- **Auth Service [PostgreSQL]**:
  - Функция: Отвечает за аутентификацию и авторизацию.
  - Технологии: PostgreSQL для хранения данных, Apache Kafka для публикации событий пользователей (Pub: User Events).
  - Взаимодействие: Принимает запросы через API Gateway (gRPC/REST), публикует события в Kafka.

- **User Service [PostgreSQL]**:
  - Функция: Управляет данными пользователей.
  - Технологии: PostgreSQL для хранения данных, Apache Kafka для публикации событий пользователей (Pub: User Events).
  - Взаимодействие: Принимает запросы через API Gateway (gRPC/REST), публикует события в Kafka.

- **Friendship Service [PostgreSQL]**:
  - Функция: Управляет социальными связями (дружбой).
  - Технологии: PostgreSQL для хранения данных, Apache Kafka для публикации событий пользователей (Pub: User Events).
  - Взаимодействие: Принимает запросы через API Gateway (gRPC/REST), публикует события в Kafka.

## Общая инфраструктура

- **Redis Cluster [Cache]**:
  - Функция: Кэширование данных и механизм публикации/подписки (Pub/Sub).
  - Используется сервисами: Notification Service, Media Service, Messaging Service.

- **Apache Kafka [Event Bus]**:
  - Функция: Асинхронное взаимодействие между сервисами через шину событий.
  - Поддерживает:
    - Публикацию событий контента (Post Service, Comment Service, Newsfeed Service).
    - Публикацию событий пользователей (Auth Service, User Service, Friendship Service).
    - Подписку на события лент (Newsfeed Service).
    - Подписку на события поиска (Search Service).

## Взаимодействие между компонентами

1. **Пользователи и администраторы** отправляют запросы через API Gateway по HTTPS.
2. **API Gateway** маршрутизирует запросы к микросервисам по gRPC/REST.
3. **Notification Service** отправляет уведомления через внешние сервисы, используя Redis для кэширования и подписки.
4. **Media Service** доставляет медиа через CDN, подписывается на уведомления через Redis.
5. **Messaging Service** обеспечивает обмен сообщениями через WebSocket, подписывается на уведомления через Redis.
6. **Search Service** получает поисковые события через Apache Kafka.
7. **Admin Service** обрабатывает административные запросы от API Gateway.
8. **Post Service, Comment Service, Newsfeed Service** публикуют события контента в Kafka; Newsfeed Service также подписывается на события лент.
9. **Auth Service, User Service, Friendship Service** публикуют события пользователей в Kafka.
10. **Apache Kafka** служит шиной событий для асинхронного обмена данными.
11. **Redis Cluster** используется для кэширования и Pub/Sub механизма уведомлений.

## Итог

Архитектура представляет чётко структурированную систему микросервисов. Каждый сервис отвечает за свою задачу, взаимодействуя через API Gateway для синхронных запросов и Apache Kafka для асинхронных событий. Redis обеспечивает кэширование и уведомления, что делает систему масштабируемой и надёжной.